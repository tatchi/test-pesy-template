# Cross-platform set of build steps for building esy projects

steps:
  - template: utils/use-node.yml
  - template: utils/use-cache-yarn.yml
  - template: utils/use-esy.yml
  - script: "esy install"
    displayName: "esy install"
    condition: ne(variables['AGENT.OS'], 'Linux')
  - template: utils/use-cache-esy.yml
  - script: "esy install --cache-tarballs-path=$(Agent.HomeDirectory)/esy-sources"
    displayName: "esy install"
    condition: eq(variables['AGENT.OS'], 'Linux')
  - template: utils/publish-sources.yml
  - template: utils/restore-build-cache.yml
  - bash: 'ls -la /Users/runner'
    displayName: 'ls -la /Users/runner'
    continueOnError: true
  - bash: 'ls -la /Users/runner/.esy'
    displayName: 'ls -la /Users/runner/.esy'
    continueOnError: true
  - bash: 'ls -la /Users/runner/.esy/3'
    displayName: 'ls -la /Users/runner/.esy/3'
    continueOnError: true
  - bash: 'ls -la'
    displayName: 'ls $(ESY__CACHE_INSTALL_PATH)/../../source'
    continueOnError: true
    workingDirectory: $(ESY__CACHE_INSTALL_PATH)/../../source
  - bash: 'ls -la'
    displayName: 'ls $(ESY__CACHE_INSTALL_PATH)/../../'
    continueOnError: true
    workingDirectory: $(ESY__CACHE_INSTALL_PATH)/../../
  - bash: 'ls -la'
    displayName: 'ls $(ESY__CACHE_INSTALL_PATH)/../'
    continueOnError: true
    workingDirectory: $(ESY__CACHE_INSTALL_PATH)/../
  - bash: 'ls -la'
    displayName: 'ls $(ESY__CACHE_INSTALL_PATH)'
    continueOnError: true
    workingDirectory: $(ESY__CACHE_INSTALL_PATH)
  - bash: 'ls -la'
    displayName: 'ls $(Agent.HomeDirectory)'
    continueOnError: true
    workingDirectory: $(Agent.HomeDirectory)
  - script: "esy build --release"
    displayName: "esy build --release"
  - script: "esy release"
    displayName: "esy release"
  - template: utils/publish-build-cache.yml
